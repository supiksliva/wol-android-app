name: Build Android APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK and NDK
      run: |
        echo "=== INSTALLING SYSTEM DEPENDENCIES ==="
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-venv \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          wget \
          unzip \
          ant \
          make
        
        echo "=== DOWNLOADING ANDROID COMMAND LINE TOOLS ==="
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        mkdir -p ~/android-sdk
        unzip -q commandlinetools-linux-9477386_latest.zip -d ~/android-sdk
        mv ~/android-sdk/cmdline-tools ~/android-sdk/latest
        
        echo "ANDROID_SDK_ROOT=~/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=~/android-sdk" >> $GITHUB_ENV
        echo "PATH=~/android-sdk/latest/bin:$PATH" >> $GITHUB_ENV
        
        echo "=== ACCEPTING ANDROID LICENSES ==="
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        # Создаем файл с принятыми лицензиями
        mkdir -p ~/android-sdk/licenses
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/android-sdk/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/android-sdk/licenses/android-sdk-preview-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" > ~/android-sdk/licenses/intel-android-extra-license
        
        echo "=== INSTALLING ANDROID COMPONENTS ==="
        # Устанавливаем конкретные стабильные версии
        ~/android-sdk/latest/bin/sdkmanager --sdk_root=~/android-sdk \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.0" \
          "ndk;25.2.9519653" \
          "cmake;3.22.1" 2>&1 | tail -30
        
        echo "=== VERIFYING INSTALLATION ==="
        echo "SDK location: ~/android-sdk"
        ls -la ~/android-sdk/build-tools/33.0.0/aidl 2>/dev/null && echo "✅ AIDL found" || echo "❌ AIDL not found"
        ls -la ~/android-sdk/ndk/25.2.9519653 2>/dev/null && echo "✅ NDK found" || echo "❌ NDK not found"
    
    - name: Install Buildozer and dependencies
      run: |
        echo "=== INSTALLING BUILDOZER ==="
        pip install buildozer==1.5.0 cython==0.29.36
        
        echo "=== CHECKING PYTHON ENVIRONMENT ==="
        python --version
        pip --version
    
    - name: Configure Buildozer environment
      run: |
        echo "=== CONFIGURING BUILDOZER ENVIRONMENT ==="
        
        # Создаем глобальную конфигурацию Buildozer
        mkdir -p ~/.buildozer
        cat > ~/.buildozer/config.ini << EOF
[app]
# Пути к уже установленным компонентам
android.sdk_path = ~/android-sdk
android.ndk_path = ~/android-sdk/ndk/25.2.9519653
android.ant_path = /usr/bin/ant

# ОТКЛЮЧАЕМ автоскачивание - ключевая настройка!
android.auto_sdk = False
android.auto_ndk = False
android.auto_ant = False

# Конкретные версии
android.sdk = 33
android.ndk = 25.2.9519653
android.build_tools_version = 33.0.0
EOF
        
        # Создаем локальную конфигурацию
        mkdir -p .buildozer
        cat > .buildozer/config.ini << EOF
[app]
android.sdk_path = ~/android-sdk
android.ndk_path = ~/android-sdk/ndk/25.2.9519653
android.auto_sdk = False
EOF
        
        # Создаем симлинки чтобы Buildozer нашел наши файлы
        mkdir -p ~/.buildozer/android/platform
        ln -sf ~/android-sdk ~/.buildozer/android/platform/android-sdk 2>/dev/null || true
        
        echo "=== ENVIRONMENT VARIABLES ==="
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_NDK_HOME: $ANDROID_SDK_ROOT/ndk/25.2.9519653"
    
    - name: Build APK with Buildozer
      id: build-step
      run: |
        echo "=== STARTING APK BUILD PROCESS ==="
        
        # Устанавливаем критические переменные окружения
        export ANDROID_SDK_ROOT=~/android-sdk
        export ANDROID_NDK_HOME=~/android-sdk/ndk/25.2.9519653
        export ANDROID_HOME=~/android-sdk
        export PATH=~/android-sdk/platform-tools:~/android-sdk/build-tools/33.0.0:$PATH
        
        echo "Current PATH: $PATH"
        echo "Checking aidl:"
        which aidl || echo "aidl not in PATH"
        ls -la ~/android-sdk/build-tools/33.0.0/aidl 2>/dev/null || echo "aidl not found in SDK"
        
        # Очищаем предыдущие сборки
        rm -rf .buildozer bin 2>/dev/null || true
        
        echo "=== RUNNING BUILDOZER ==="
        # Запускаем Buildozer с максимальным логгированием
        buildozer android debug 2>&1 | tee full_build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        echo "Buildozer exit code: $BUILD_EXIT_CODE"
        
        echo "=== ANALYZING BUILD RESULTS ==="
        
        # Проверяем создался ли APK
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ SUCCESS: APK file created!"
          echo "APK details:"
          ls -la bin/*.apk
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          echo "apk_path=bin" >> $GITHUB_OUTPUT
        else
          echo "❌ FAILURE: APK file NOT created!"
          echo "=== SHOWING CRITICAL ERRORS ==="
          grep -i "error\|failed\|not found\|missing\|rejected\|download\|license" full_build.log | head -30
          echo "=== LAST 50 LINES OF LOG ==="
          tail -50 full_build.log
          echo "=== CHECKING DIRECTORY STRUCTURE ==="
          find . -name "*.apk" -type f 2>/dev/null
          ls -la .buildozer/ 2>/dev/null || echo ".buildozer not found"
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          exit 1
        fi
      env:
        # Критические переменные для отключения автоскачивания
        BUILDOZER_DISABLE_AUTO_SDK: 1
        BUILDOZER_DISABLE_AUTO_NDK: 1
        BUILDOZER_LOG_LEVEL: 2
    
    - name: Upload APK artifact
      if: steps.build-step.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: wol-android-app
        path: bin/*.apk
        retention-days: 30
    
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-logs
        path: |
          full_build.log
          .buildozer/logs/
        retention-days: 7
