name: Build Android APK - Debug Version

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          wget
    
    - name: Install Buildozer
      run: |
        pip install buildozer==1.5.0 cython==0.29.36
    
    - name: Show environment info
      run: |
        echo "=== SYSTEM INFO ==="
        python3 --version
        pip --version
        java -version
        echo "=== DIRECTORY STRUCTURE ==="
        find . -type f -name "*.py" -o -name "*.spec" | head -20
    
    - name: Run Buildozer with detailed logging
      id: buildozer-run
      continue-on-error: true  # Продолжить даже если сборка упадет
      run: |
        echo "=== STARTING BUILDOZER ==="
        
        # 1. Очистить предыдущие сборки
        rm -rf .buildozer bin 2>/dev/null || true
        
        # 2. Запустить Buildozer с детальным логом
        # Сохраняем вывод в файл
        set -o pipefail
        buildozer android debug 2>&1 | tee full_build.log
        
        # 3. Проверить результат
        BUILD_EXIT_CODE=$?
        echo "Buildozer exit code: $BUILD_EXIT_CODE"
        
        # 4. Поискать APK файлы
        echo "=== SEARCHING FOR APK FILES ==="
        find . -name "*.apk" -type f 2>/dev/null
        
        # 5. Проверить папку bin
        if [ -d "bin" ]; then
          echo "=== CONTENTS OF bin/ ==="
          ls -la bin/
        else
          echo "bin/ directory does not exist"
        fi
        
        # 6. Показать последние строки лога
        echo "=== LAST 150 LINES OF BUILD LOG ==="
        tail -150 full_build.log
        
        # 7. Показать ошибки если есть
        echo "=== ERRORS IN LOG ==="
        grep -i "error\|failed\|exception\|not found" full_build.log | head -30
        
        exit $BUILD_EXIT_CODE
    
    - name: Upload build logs
      if: always()  # Загрузить логи всегда, даже при ошибке
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          full_build.log
          .buildozer/logs/
    
    - name: Upload APK if exists
      if: steps.buildozer-run.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
