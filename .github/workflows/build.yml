name: Build Android APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          wget \
          unzip
        
        # Устанавливаем Android SDK
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        mkdir -p ~/android-sdk
        unzip -q commandlinetools-linux-9477386_latest.zip -d ~/android-sdk
        mv ~/android-sdk/cmdline-tools ~/android-sdk/latest
        
        echo "ANDROID_SDK_ROOT=~/android-sdk" >> $GITHUB_ENV
        echo "PATH=~/android-sdk/latest/bin:$PATH" >> $GITHUB_ENV
        
        # Принимаем лицензии и устанавливаем компоненты
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        yes | ~/android-sdk/latest/bin/sdkmanager --sdk_root=~/android-sdk \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.0" 2>&1 | tail -30
    
    - name: Install Buildozer
      run: |
        pip install buildozer cython
    
    - name: Build APK with full debug
      id: build
      run: |
        echo "=== STARTING BUILDOZER (LOG LEVEL 2) ==="
        
        # Очищаем предыдущие сборки
        rm -rf .buildozer bin 2>/dev/null || true
        
        # Запускаем с полным логом
        buildozer android debug 2>&1 | tee full_build.log
        
        # Анализируем результат
        echo "=== BUILD ANALYSIS ==="
        
        # 1. Проверяем папку bin
        if [ -d "bin" ]; then
          echo "Found bin directory:"
          ls -la bin/
          APK_COUNT=$(ls -1 bin/*.apk 2>/dev/null | wc -l)
          echo "APK files found: $APK_COUNT"
        else
          echo "bin directory NOT created"
        fi
        
        # 2. Ищем ошибки в логе
        echo "=== SEARCHING FOR ERRORS ==="
        ERROR_LINES=$(grep -i "error\|failed\|exception\|not found\|missing" full_build.log | wc -l)
        echo "Lines with errors: $ERROR_LINES"
        
        if [ $ERROR_LINES -gt 0 ]; then
          echo "First 10 errors:"
          grep -i "error\|failed\|exception\|not found\|missing" full_build.log | head -10
        fi
        
        # 3. Показываем последние строки лога
        echo "=== LAST 50 LINES OF LOG ==="
        tail -50 full_build.log
        
        # 4. Проверяем создан ли APK
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK FILE CREATED SUCCESSFULLY"
          ls -lh bin/*.apk
        else
          echo "❌ NO APK FILE CREATED"
          echo "Build failed silently. Check full_build.log for details."
          # Завершаем с ошибкой, чтобы workflow показал проблему
          exit 1
        fi
      env:
        BUILDOZER_LOG_LEVEL: 2
        ANDROID_SDK_ROOT: ~/android-sdk
    
    - name: Upload APK
      if: steps.build.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
    
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-debug-log
        path: full_build.log
